<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: CompaniesData.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: CompaniesData.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Utils from './Utils';
import { renderResults, renderPagination} from './htmlTemplates';

export default class CompaniesData{

    
    /**
     * @constructor
     */
    constructor(){
        /** *
        * Data of companies gathered from two tables after summarize and calculate incomes for each one
        * @type {array}
        * @param {*} filteredData After application initialization contains full unfiltered data.
        * @param {*} pageNumber 
        * @param {*} pageSize 
        */
        this.wholeData;
        this.filteredData;
        this.pageNumber = 1;
        this.pageSize = 10;
        this.utils = new Utils();
         this.init();
    }

    setWholeData(data){ this.wholeData = data; }
    getWholeData(){ return this.wholeData; }

    setFilteredData(data){ this.filteredData = data; }
    getFilteredData(){ return this.filteredData; }

    /**
    * 
    */
    init(){
        this.fetchSelectors();
        
        this.fetchData().then((data) => {
            this.setWholeData(data);
            this.setFilteredData(data);
            const sorted = this.sortResults('id', true, this.wholeData);
            const sliced = this.slicedData(sorted);
            renderResults(sliced, this.dataRows);
            renderPagination(this.getWholeData(), this.paginationSelect);
            this.addEventsListeners();
        });
    }
    /**
    * Assigning to variable static elements of the HTML
    */
    fetchSelectors(){
        // Search selectors
        this.searchInput = document.querySelector('.search__input');
        this.searchButton = document.querySelector('.search__button');
        // Pagination selectors
        this.paginationSelect = document.querySelector('.pagination__select');
        this.prevBtn = document.querySelector('.previous-page');
        this.nextBtn = document.querySelector('.next-page');
        // Table selectors
        this.headers = document.querySelectorAll('[data-header-id]');
        this.dataRows = document.querySelector('.data-rows');
        this.loading = document.querySelector('.loading');
    }

    /**
    * Assigning event listeners to static elements of the HTML
    */
    addEventsListeners(){
        // Search event listeners
        this.searchInput.addEventListener('submit', (event) => {
            event.preventDefault();
        });
        this.searchButton.addEventListener('click', () => {
            const filteredData = this.filterByKeyword(this.searchInput.value, this.wholeData);
            this.setFilteredData(filteredData);
            renderResults(this.slicedData(this.filteredData), this.dataRows);
            renderPagination(this.filteredData, this.paginationSelect);
        }); // Search event listeners END
        
        this.headers.forEach(el => el.addEventListener('click', (event) => {
            const clicked = event.target;
            if(clicked.hasAttribute('data-header-id') === false){ return; }
            if  (!clicked.classList.contains('active')) {
                document.querySelector('.active').classList.remove('active');
                clicked.classList.add("active");
            }

            clicked.classList.toggle("ascending");
            
            const sortKey = clicked.getAttribute('data-header-id');
            const isAscending =  clicked.classList.contains("ascending");
            const sorted = this.sortResults(sortKey, isAscending, this.getFilteredData());
            const sliced = this.slicedData(sorted);
            
            renderResults(sliced, this.dataRows);
        }));

        // Pagination event listeners
        this.prevBtn.addEventListener('click', () => {
            if(this.paginationSelect.value > 1){
                const sliced = this.slicedData(this.getFilteredData(), Number(this.paginationSelect.value)-1)
                this.paginationSelect.value = Number(this.paginationSelect.value)-1;
                renderResults(sliced, this.dataRows);
            }
        });
        this.nextBtn.addEventListener('click', () => {
            if(this.paginationSelect.value &lt; this.paginationSelect.length){
                const sliced = this.slicedData(this.getFilteredData(), Number(this.paginationSelect.value)+1)
                this.paginationSelect.value = Number(this.paginationSelect.value)+1;
                renderResults(sliced, this.dataRows);
            }
        });
        this.paginationSelect.addEventListener('change', (event) => {
            const sliced = this.slicedData(this.getFilteredData(), Number(event.target.value))
            renderResults(sliced, this.dataRows);
        });// Pagination event listeners END
    }

    /**
     * Using fetch(url) and get companies data, then convert response to json. 
     * Next, Promise.all make sure that another data table is loaded and converted to json before next step which is modifying companies array. 
     * Now the algorithm for every company array row add some extra properties to object, which are calculated by functions declarated before Promise.all,
     * getTotalIncome() and getLastIncome(). Function getData is used on line 20 with then(), 
     * where global variable is filled with complete data about companies and their incomes.
    */
    fetchData(){
        return this.utils.connectToOrigin('https://recruitment.hal.skygate.io/companies')
        .then((response) => response.json())
        .then((companies) => {
            // calculate total, average and last income
            return Promise.all(
                companies.map((company) =>
                this.utils.connectToOrigin(`https://recruitment.hal.skygate.io/incomes/${company.id}`)
                    .then((response) => response.json())
                )
            )
            .then((companyIncomes) => {
                const mergedCompaniesIncomes = [];
                companies.forEach((company, index) => {
                    mergedCompaniesIncomes.push({...company, ...this.countIncomes(companyIncomes[index])});
                });
                return mergedCompaniesIncomes;
            });
            
        })
    }

    /**
     * 
     * @param {*} companyIncomes 
     */
    countIncomes(companyIncomes){
        const sum = this.utils.getTotalIncome(companyIncomes.incomes);
        const sortedIncomes = this.sortResults('date', false, companyIncomes.incomes);
        const lastDate = new Date(sortedIncomes[0].date);
        const lastMonthDate = new Date(lastDate.getFullYear(), lastDate.getMonth());
        return {
            totalIncome: sum,
            averageIncome: (sum/companyIncomes.incomes.length).toFixed(2),
            lastMonthIncomes: this.utils.getTotalIncome(sortedIncomes.filter(income => new Date(income.date) >= lastMonthDate))
        }
    }

    /**
     * Function serves for pagination, it needs filtered, or whole data, page which user requested and number of rows that will be rendered.
     * @param {*} filteredData
     * @param {*} pageNumber 
     * @param {*} pageSize 
     */
    slicedData(filteredData, pageNumber = 1, pageSize = 10){
        const firstRow = (pageNumber-1)*pageSize;
        const lastRow = firstRow + pageSize;
        return filteredData.slice(firstRow, lastRow);
    }

    /**
     * Filtering start when input text have some content and Search button is clicked, if text is empty table will be filled with defaults start rows. 
     * Function is using filter with callback on global variable companiesData. If one of the properties is similar to keyWords, 
     * object from array is returning by filter to newArray. After complete filtering results are sorted by id, in ascending order.
     * @param {*} searchKeyword 
     * @param {*} data 
     */
    filterByKeyword(searchKeyword, data){
        searchKeyword = this.searchInput.value;
        this.setFilteredData()
        return data.filter(company => 
            Object
            .values(company)
            .some((value) => {
                return String(value).toUpperCase().includes(searchKeyword.toUpperCase());
            })
        );
    }

// SORTING
    sortResults(sortKey, isAscending, array){
        function compare(a, b) {
            const itemA = a[sortKey];
            const itemB = b[sortKey];
            let comparison = 0;
            comparison = itemA > itemB ? 1 : 0;
            comparison = itemA &lt; itemB ? -1 : 1;
            isAscending ? comparison *= 1 : comparison *= -1;
            return comparison;
        }
        const sorted = array.sort(compare);
        return sorted;
    }
// SORTING END

    changePage(requestedPage = 1, rowsSeen = 10){
        const firstRowLoaded = (requestedPage - 1) * 10;
        const lastRowLoaed = firstRowLoaded + rowsSeen;

        Array.prototype.slice.call(document.querySelectorAll('.showed-row')) // Hiding all rows
        .map(row => row.setAttribute('class', 'hidden-row'));

        Array.prototype.slice.call(document.querySelectorAll('.hidden-row')) // Showing rows depending on start and how many
        .slice(firstRowLoaded, lastRowLoaed).map(row => row.setAttribute('class', 'showed-row row'));
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module.exports_module.exports.html">exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addEventsListeners">addEventsListeners</a></li><li><a href="global.html#countIncomes">countIncomes</a></li><li><a href="global.html#fetchData">fetchData</a></li><li><a href="global.html#fetchSelectors">fetchSelectors</a></li><li><a href="global.html#filterByKeyword">filterByKeyword</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#slicedData">slicedData</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Fri May 29 2020 20:39:09 GMT+0200 (GMT+02:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
